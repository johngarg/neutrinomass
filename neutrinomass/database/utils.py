#!/usr/bin/env python3

import sympy
from neutrinomass.database.closures import (
    neutrino_mass_estimate,
    numerical_np_scale_estimate,
)


def get_leading_mv(eff_op):
    """Returns the symbolic expression for the leading order contribution to the
    neutrino mass implied by the operator.

    """
    estimates = neutrino_mass_estimate(eff_op)
    numerical = [(e, numerical_np_scale_estimate(e)) for e in estimates]
    return sorted(numerical, key=lambda x: round(x[1], 2))[-1][0]


def estimate_np_scale(eff_op):
    estimates = neutrino_mass_estimate(eff_op)
    numerical = [numerical_np_scale_estimate(e) for e in estimates]
    return numerical


def loop_data(expr):
    n_loops, n_loops_v2, max_loops = 0, [], 8
    for n in range(1, max_loops):
        if expr.coeff(sympy.Symbol("loop") ** n):
            n_loops += n

        if expr.coeff(sympy.Symbol("loopv2") ** n):
            n_loops_v2 += sorted([n - j for j in range(n + 1)])

    return n_loops, n_loops_v2


def table_data(eff_op):
    estimates = neutrino_mass_estimate(eff_op)
    numerical = [(e, numerical_np_scale_estimate(e)) for e in estimates]
    expr, np_scale = sorted(numerical, key=lambda x: round(x[1], 2))[-1]

    n_loops, n_loops_v2 = loop_data(expr)

    n_loops_str = (
        str(n_loops)
        if not n_loops_v2
        else ",".join(str(i + n_loops) for i in n_loops_v2)
    )
    return n_loops_str, f"\\mynum{{{np_scale}}}"


ONE_LOOP_WEINBERG = [
    6145,
    6149,
    6152,
    6185,
    6186,
    6187,
    6188,
    6190,
    4146,
    6198,
    6199,
    6200,
    6202,
    4167,
    93,
    94,
    95,
    96,
    97,
    98,
    100,
    101,
    6247,
    6248,
    105,
    6249,
    106,
    6252,
    108,
    6253,
    6258,
    6260,
    6261,
    6262,
    6273,
    4228,
    4250,
    14492,
    14493,
    6309,
    6311,
    6312,
    12464,
    6324,
    6328,
    6330,
    6331,
    6334,
    6337,
    6338,
    6340,
    6341,
    6364,
    6366,
    6368,
    12512,
    6370,
    6372,
    6373,
    6379,
    6381,
    6385,
    6386,
    4339,
    6389,
    6390,
    6395,
    6397,
    6402,
    6406,
    12551,
    6410,
    6414,
    6416,
    6421,
    6423,
    6424,
    6425,
    6428,
    4381,
    6429,
    4384,
    6433,
    6436,
    6437,
    6442,
    6444,
    6445,
    6464,
    6465,
    6466,
    6469,
    6473,
    6474,
    6476,
    6477,
    6478,
    6479,
    6480,
    6482,
    6483,
    6485,
    6487,
    6488,
    4449,
    12649,
    6520,
    6521,
    4476,
    6524,
    6525,
    6526,
    6529,
    6530,
    6535,
    6536,
    6537,
    6538,
    6540,
    6541,
    12690,
    7424,
    6636,
    6637,
    6639,
    6640,
    6641,
    4594,
    6642,
    6648,
    12792,
    6649,
    6650,
    6654,
    4621,
    4622,
    6670,
    6674,
    6675,
    6676,
    6677,
    6678,
    6679,
    6682,
    6691,
    6692,
    6716,
    6718,
    6739,
    6746,
    6748,
    6749,
    6765,
    6766,
    6767,
    10865,
    10866,
    6769,
    6776,
    6779,
    10875,
    6781,
    10879,
    6783,
    6793,
    6796,
    8845,
    4750,
    6800,
    6805,
    6810,
    6816,
    8868,
    8869,
    6822,
    6823,
    6824,
    8870,
    8871,
    6828,
    6829,
    6831,
    6833,
    6834,
    7464,
    5429,
    6850,
    10947,
    10948,
    6852,
    6854,
    6851,
    6856,
    6853,
    6855,
    6857,
    8902,
    8907,
    8908,
    8909,
    8910,
    6875,
    6876,
    6878,
    6880,
    4844,
    7477,
    7478,
    7479,
    7480,
    6917,
    6918,
    7481,
    6920,
    6919,
    6922,
    6923,
    7482,
    6924,
    6921,
    6925,
    6926,
    6928,
    6929,
    6932,
    6933,
    6934,
    6935,
    11029,
    11030,
    7484,
    7485,
    6939,
    6940,
    6941,
    6943,
    7486,
    6945,
    6946,
    6947,
    6942,
    6949,
    7487,
    6951,
    6952,
    6948,
    6954,
    11559,
    6970,
    6972,
    6973,
    6974,
    6975,
    6976,
    6977,
    6978,
    6979,
    11564,
    4935,
    6986,
    11565,
    6987,
    11566,
    6995,
    6996,
    6997,
    6999,
    7001,
    7003,
    7004,
    11569,
    7007,
    11571,
    11572,
    7022,
    7026,
    11573,
    7028,
    7027,
    11574,
    7033,
    7036,
    7037,
    7038,
    7039,
    7040,
    7041,
    11576,
    7043,
    11577,
    11578,
    7052,
    7055,
    7057,
    7058,
    11579,
    11580,
    7066,
    7068,
    7069,
    7070,
    7077,
    7078,
    5035,
    7085,
    7086,
    7087,
    7088,
    7093,
    7095,
    7096,
    7101,
    7102,
    7103,
    7104,
    7105,
    7107,
    7109,
    7110,
    7111,
    7112,
    7113,
    7114,
    7125,
    7126,
    7127,
    7128,
    7129,
    7130,
    7131,
    7133,
    7134,
    7135,
    7136,
    7137,
    7138,
    7139,
    7140,
    7142,
    7145,
    7147,
    7149,
    5103,
    7151,
    7155,
    7160,
    7162,
    7174,
    7175,
    7176,
    7177,
    7178,
    7179,
    7180,
    7182,
    7183,
    7185,
    7190,
    7191,
    7192,
    7193,
    7194,
    7195,
    7196,
    7198,
    7200,
    7202,
    7208,
    7210,
    7214,
    5167,
    7216,
    7220,
    7221,
    7227,
    7228,
    7231,
    7232,
    7234,
    7238,
    7241,
    7242,
    7247,
    7248,
    7250,
    7253,
    7263,
    7264,
    7266,
    7267,
    7268,
    7269,
    7270,
    7272,
    7274,
    7275,
    7282,
    7283,
    7284,
    7285,
    7286,
    7287,
    7288,
    7290,
    7292,
    7293,
    7295,
    7299,
    7308,
    7309,
    7310,
    7311,
    7312,
    7313,
    7314,
    7315,
    7316,
    7322,
    7334,
    7335,
    7336,
    7338,
    7339,
    7340,
    7341,
    7342,
    7343,
    7344,
    7345,
    5297,
    7346,
    7348,
    7347,
    7350,
    7351,
    7353,
    7362,
    11461,
    11463,
    7377,
    7379,
    7405,
    7408,
    7414,
    11511,
    11512,
    11513,
    7415,
    7416,
    7417,
    7421,
    7422,
    11519,
    7420,
    11521,
    11522,
    11523,
    7427,
    11524,
    11526,
    11527,
    11528,
    11525,
    7426,
    7439,
    11537,
    11538,
    11539,
    11540,
    7443,
    11544,
    11545,
    11546,
    11547,
    11549,
    5407,
    11556,
    11557,
    5412,
    5415,
    11560,
    11561,
    11562,
    5416,
    5417,
    5418,
    11563,
    5420,
    5421,
    5422,
    5423,
    5424,
    5425,
    5426,
    5427,
    5428,
    11567,
    11568,
    5432,
    5433,
    5434,
    5435,
    5436,
    5437,
    5438,
    5439,
    5440,
    5441,
    5442,
    5443,
    5444,
    5445,
    5448,
    7490,
    7489,
    5449,
    7501,
    7502,
    7503,
    7504,
    7505,
    7506,
    7507,
    7508,
    7510,
    7511,
    7512,
    7513,
    7518,
    7542,
    7543,
    7544,
    7545,
    7546,
    13688,
    13689,
    13693,
    13694,
    13695,
    7547,
    5534,
    5536,
    5538,
    5539,
    5540,
    5542,
    5543,
    5544,
    5545,
    5554,
    5559,
    5567,
    5584,
    5586,
    5587,
    5588,
    5590,
    5591,
    5592,
    5594,
    9693,
    5598,
    5599,
    9699,
    9702,
    5614,
    5621,
    5622,
    7694,
    7695,
    7696,
    5653,
    5690,
    5691,
    9813,
    7777,
    7782,
    7784,
    5737,
    7787,
    5740,
    5741,
    5742,
    5746,
    5747,
    5748,
    5756,
    5757,
    5759,
    5761,
    5764,
    5786,
    7838,
    5792,
    9896,
    9898,
    5804,
    9903,
    9908,
    9911,
    7864,
    7865,
    5818,
    7867,
    9913,
    7869,
    5816,
    9915,
    5817,
    9921,
    7874,
    5827,
    7876,
    7877,
    5826,
    5829,
    5832,
    5834,
    5835,
    5837,
    5839,
    5842,
    5863,
    5865,
    5866,
    5867,
    5869,
    5871,
    5873,
    5875,
    5878,
    5880,
    5882,
    5883,
    9980,
    9983,
    9989,
    9990,
    9991,
    9992,
    5909,
    5910,
    5911,
    10055,
    10058,
    10069,
    10073,
    10075,
    10076,
    6054,
    6056,
    6057,
    6058,
    6059,
    6061,
    6062,
    6064,
    6065,
    6073,
    6076,
    6079,
    6080,
    6081,
    6082,
    6083,
    6085,
    6086,
    6087,
    6089,
    6090,
    6093,
    6109,
    6110,
    6112,
    6113,
    6115,
    6117,
    6121,
    6122,
    6125,
    6127,
    6129,
    6130,
    6131,
    6132,
]
